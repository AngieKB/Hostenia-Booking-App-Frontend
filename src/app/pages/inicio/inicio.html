<app-empty-header></app-empty-header>

<!-- Contenido principal -->
<div class="container-fluid py-5" style="background-color: #E8F5E9; min-height: calc(100vh - 200px);">
  
  <div class="row justify-content-center">
    <!-- Sección de Registro -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Registrarse</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="registroForm" (ngSubmit)="registrar()">
            <!-- Nombre -->
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input 
                type="text" 
                class="form-control" 
                [class.is-invalid]="nombreControl?.invalid && nombreControl?.touched"
                placeholder="Ingrese su nombre"
                formControlName="nombre">
              <div class="invalid-feedback" *ngIf="nombreControl?.invalid && nombreControl?.touched">
                <small *ngIf="nombreControl?.errors?.['required']">El nombre es requerido</small>
                <small *ngIf="nombreControl?.errors?.['maxlength']">El nombre no puede exceder 30 caracteres</small>
              </div>
            </div>

            <!-- Correo electrónico -->
            <div class="mb-3">
              <label class="form-label">Correo electrónico</label>
              <input 
                type="email" 
                class="form-control" 
                [class.is-invalid]="emailControl?.invalid && emailControl?.touched"
                placeholder="Ingrese su correo electrónico"
                formControlName="email">
              <div class="invalid-feedback" *ngIf="emailControl?.invalid && emailControl?.touched">
                <small *ngIf="emailControl?.errors?.['required']">El correo es requerido</small>
                <small *ngIf="emailControl?.errors?.['email']">Ingrese un correo válido</small>
              </div>
            </div>

            <!-- Contraseña -->
            <div class="mb-3">
              <label class="form-label">Contraseña</label>
              <input 
                type="password" 
                class="form-control" 
                [class.is-invalid]="passwordControl?.invalid && passwordControl?.touched"
                placeholder="Ingrese la contraseña que desea"
                formControlName="password">
              <div class="invalid-feedback" *ngIf="passwordControl?.invalid && passwordControl?.touched">
                <small *ngIf="passwordControl?.errors?.['required']" class="d-block">La contraseña es requerida</small>
                <small *ngIf="passwordControl?.errors?.['minlength']" class="d-block">Mínimo 8 caracteres</small>
                <small *ngIf="passwordControl?.errors?.['pattern']" class="d-block">Debe contener mayúscula, minúscula y número</small>
              </div>
            </div>

            <!-- Teléfono -->
            <div class="mb-3">
              <label class="form-label">Teléfono</label>
              <input 
                type="tel" 
                class="form-control" 
                [class.is-invalid]="telefonoControl?.invalid && telefonoControl?.touched"
                placeholder="Ingrese su número de teléfono"
                formControlName="telefono">
              <div class="invalid-feedback" *ngIf="telefonoControl?.invalid && telefonoControl?.touched">
                <small *ngIf="telefonoControl?.errors?.['required']">El teléfono es requerido</small>
                <small *ngIf="telefonoControl?.errors?.['maxlength']">El teléfono no puede exceder 10 caracteres</small>
              </div>
            </div>

            <!-- Fecha de nacimiento -->
            <div class="mb-3">
              <label class="form-label">Fecha de nacimiento</label>
              <input 
                type="date" 
                class="form-control" 
                [class.is-invalid]="fechaNacimientoControl?.invalid && fechaNacimientoControl?.touched"
                placeholder="Selecciona una fecha"
                formControlName="fechaNacimiento">
              <div class="invalid-feedback" *ngIf="fechaNacimientoControl?.invalid && fechaNacimientoControl?.touched">
                <small *ngIf="fechaNacimientoControl?.errors?.['required']">La fecha de nacimiento es requerida</small>
              </div>
            </div>

            <!-- Foto de perfil -->
            <div class="mb-3">
              <label class="form-label">Foto de perfil (opcional)</label>
              <input 
                type="file" 
                class="form-control" 
                accept="image/*"
                (change)="onFileSelected($event)">
              <small class="text-muted">Formatos aceptados: JPG, PNG, GIF</small>
            </div>

            <!-- Botón de registro -->
            <button 
              type="submit" 
              class="btn btn-success w-100"
              [disabled]="registrando">
              <span *ngIf="registrando" class="spinner-border spinner-border-sm me-2"></span>
              {{ registrando ? 'Registrando...' : 'Registrar' }}
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Sección de Iniciar Sesión -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Iniciar Sesión</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="loginForm" (ngSubmit)="iniciarSesion()">
            <!-- Correo electrónico -->
            <div class="mb-3">
              <label class="form-label">Correo electrónico</label>
              <input 
                type="email" 
                class="form-control" 
                [class.is-invalid]="loginEmailControl?.invalid && loginEmailControl?.touched"
                placeholder="Ingrese su correo electrónico"
                formControlName="email">
              <div class="invalid-feedback" *ngIf="loginEmailControl?.invalid && loginEmailControl?.touched">
                <small *ngIf="loginEmailControl?.errors?.['required']">El correo es requerido</small>
                <small *ngIf="loginEmailControl?.errors?.['email']">Ingrese un correo válido</small>
              </div>
            </div>

            <!-- Contraseña -->
            <div class="mb-3">
              <label class="form-label">Contraseña</label>
              <input 
                type="password" 
                class="form-control" 
                [class.is-invalid]="loginPasswordControl?.invalid && loginPasswordControl?.touched"
                placeholder="Ingrese su contraseña"
                formControlName="password">
              <div class="invalid-feedback" *ngIf="loginPasswordControl?.invalid && loginPasswordControl?.touched">
                <small *ngIf="loginPasswordControl?.errors?.['required']">La contraseña es requerida</small>
              </div>
            </div>

            <!-- Enlace olvidaste tu contraseña -->
            <div class="mb-3 text-center">
              <a href="javascript:void(0)" class="text-success" (click)="abrirModalRecuperar()">
                ¿Olvidaste tu contraseña?
              </a>
            </div>

            <!-- Botón de ingreso -->
            <button 
              type="submit" 
              class="btn btn-success w-100"
              [disabled]="iniciandoSesion">
              <span *ngIf="iniciandoSesion" class="spinner-border spinner-border-sm me-2"></span>
              {{ iniciandoSesion ? 'Iniciando sesión...' : 'Ingresar' }}
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Recuperar Contraseña -->
<div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">Recuperar contraseña</h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Paso 1: Ingresar email y solicitar código -->
        <div *ngIf="!codigoEnviado">
          <p class="text-muted small">Ingrese su correo electrónico para recibir un código de verificación</p>
          
          <div class="mb-3">
            <label class="form-label">Correo electrónico</label>
            <input 
              type="email" 
              class="form-control" 
              [class.is-invalid]="recuperarEmailControl?.invalid && recuperarEmailControl?.touched"
              placeholder="correo@ejemplo.com"
              [formControl]="$any(recuperarForm.get('email'))">
            <div class="invalid-feedback" *ngIf="recuperarEmailControl?.invalid && recuperarEmailControl?.touched">
              <small *ngIf="recuperarEmailControl?.errors?.['required']">El correo es requerido</small>
              <small *ngIf="recuperarEmailControl?.errors?.['email']">Ingrese un correo válido</small>
            </div>
          </div>

          <button 
            type="button" 
            class="btn btn-primary w-100" 
            (click)="enviarCodigo()"
            [disabled]="enviandoCodigo">
            <span *ngIf="enviandoCodigo" class="spinner-border spinner-border-sm me-2"></span>
            {{ enviandoCodigo ? 'Enviando...' : 'Enviar código' }}
          </button>
        </div>

        <!-- Paso 2: Ingresar código y nueva contraseña -->
        <form *ngIf="codigoEnviado" [formGroup]="recuperarForm" (ngSubmit)="establecerPassword()">
          <p class="text-muted small">Se ha enviado un código de verificación a {{ recuperarForm.get('email')?.value }}</p>
          
          <!-- Código -->
          <div class="mb-3">
            <label class="form-label">Código de verificación</label>
            <input 
              type="text" 
              class="form-control" 
              [class.is-invalid]="codigoControl?.invalid && codigoControl?.touched"
              placeholder="Código"
              formControlName="codigo">
            <div class="invalid-feedback" *ngIf="codigoControl?.invalid && codigoControl?.touched">
              <small *ngIf="codigoControl?.errors?.['required']">El código es requerido</small>
            </div>
            <small class="text-muted">El código se vence en 15min</small>
          </div>

          <!-- Botón reenviar código -->
          <div class="mb-3">
            <button 
              type="button" 
              class="btn btn-info w-100" 
              (click)="reenviarCodigo()"
              [disabled]="enviandoCodigo">
              <span *ngIf="enviandoCodigo" class="spinner-border spinner-border-sm me-2"></span>
              {{ enviandoCodigo ? 'Reenviando...' : 'Reenviar código' }}
            </button>
          </div>

          <!-- Nueva contraseña -->
          <div class="mb-3">
            <label class="form-label">Nueva contraseña</label>
            <input 
              type="password" 
              class="form-control" 
              [class.is-invalid]="nuevaPasswordControl?.invalid && nuevaPasswordControl?.touched"
              placeholder="Nueva contraseña"
              formControlName="nuevaPassword">
            <div class="invalid-feedback" *ngIf="nuevaPasswordControl?.invalid && nuevaPasswordControl?.touched">
              <small *ngIf="nuevaPasswordControl?.errors?.['required']" class="d-block">La contraseña es requerida</small>
              <small *ngIf="nuevaPasswordControl?.errors?.['minlength']" class="d-block">Mínimo 8 caracteres</small>
              <small *ngIf="nuevaPasswordControl?.errors?.['pattern']" class="d-block">Debe contener mayúscula, minúscula y número</small>
            </div>
            <small class="text-muted d-block mt-1">Mínimo 8 caracteres, incluir mayúscula, minúscula y número</small>
          </div>

          <!-- Botón establecer contraseña -->
          <button 
            type="submit" 
            class="btn btn-success w-100"
            [disabled]="enviandoPassword">
            <span *ngIf="enviandoPassword" class="spinner-border spinner-border-sm me-2"></span>
            {{ enviandoPassword ? 'Estableciendo...' : 'Establecer contraseña' }}
          </button>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- Backdrop del modal -->
<div class="modal-backdrop fade" [class.show]="showModal" *ngIf="showModal" (click)="cerrarModal()"></div>

<app-footer></app-footer>